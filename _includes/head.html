<head>
	<title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="{{ page.description | default: site.description }}">
	
	<!-- Preload critical fonts -->
	<link rel="preload" href="{{ "assets/fonts/fontawesome-webfont.woff2?v=4.6.3" | relative_url }}" as="font" type="font/woff2" crossorigin>
	
	<!-- Critical CSS inline (minimalist version) -->
	<style>
		/* Minimal critical styles for initial render */
		body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;line-height:1.5}
		h1,h2{margin:0 0 1em}
		#header{position:fixed;width:100%;z-index:10000}
		#banner{position:relative;height:60vh;background-position:center;background-size:cover}
		.inner{margin:0 auto;max-width:65em;padding:0 2em}
		.button{display:inline-block;padding:0.5em 1.5em;text-decoration:none;border-radius:4px}
		
		/* Prevent image flashing on page load */
		.image picture img {
			transition: opacity 0.2s ease-in-out;
		}
		.spotlights > section {
			max-width: 90%;
			margin: 0 auto;
		}
		@media screen and (max-width: 980px) {
			.spotlights > section {
				max-width: 95%;
			}
		}
		.spotlights picture img {
			border-radius: 0;
			box-shadow: none;
		}
		html.webp-detecting .image[data-webp] {
			opacity: 0;
		}
		html.webp-complete .image[data-webp] {
			opacity: 1;
		}
	</style>
	
	<!-- Add this to your <head> section before any other scripts -->
	<style>
	  /* Prevent banner image flash during page load */
	  .banner-wrapper {
	    opacity: 0;
	    transition: opacity 0.3s ease-in-out;
	  }
	  
	  .banner-loaded .banner-wrapper {
	    opacity: 1;
	  }
	  
	  /* Preload state for banner images */
	  #banner {
	    background-image: none !important;
	    transition: background-image 0.3s ease-in-out;
	  }
	  
	  .image-preload img, 
	  .image-preload picture img {
	    opacity: 0;
	    transition: opacity 0.3s ease-in-out;
	  }
	  
	  .image-loaded img,
	  .image-loaded picture img {
	    opacity: 1;
	  }
	</style>

	<!-- Add this to your <head> section before any other scripts -->
	<style>
	  /* Prevent header image flash during page load */
	  body {
	    opacity: 0;
	    transition: opacity 0.3s ease-in-out;
	  }
	  
	  .page-loaded body {
	    opacity: 1;
	  }
	  
	  /* Preload state for header */
	  #header {
	    transition: background-color 0.3s ease-in-out;
	  }
	  
	  /* Preload state for images */
	  .image img, .image picture img {
	    opacity: 0;
	    transition: opacity 0.3s ease-in-out;
	  }
	  
	  .images-loaded .image img,
	  .images-loaded .image picture img {
	    opacity: 1;
	  }
	</style>
	
	<!-- Font Awesome - Load asynchronously -->
	<link rel="stylesheet" href="{{ "assets/css/font-awesome.min.css" | relative_url }}" media="print" onload="this.media='all'">
	<noscript><link rel="stylesheet" href="{{ "assets/css/font-awesome.min.css" | relative_url }}"></noscript>
	
	<!-- Main CSS - Load asynchronously -->
	<link rel="stylesheet" href="{{ "assets/css/main.css" | relative_url }}" media="print" onload="this.media='all'">
	<noscript><link rel="stylesheet" href="{{ "assets/css/main.css" | relative_url }}"></noscript>
	
	<!-- Favicon -->
	<link rel="shortcut icon" type="image/x-icon" href="{{ '/assets/images/favicon.ico' | relative_url }}">
	
	<!-- Preconnect to Cloudflare CDN -->
	<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
	
	<!-- Highlight.js - Load asynchronously -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css" media="print" onload="this.media='all'">
	<noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css"></noscript>
	
	<!-- Google Fonts - Load asynchronously -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300italic,600,600italic" media="print" onload="this.media='all'">
	<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300italic,600,600italic"></noscript>
	
	<!-- Improved WebP detection script -->
	<script>
	  // Add detecting class immediately
	  document.documentElement.classList.add('webp-detecting');
	  
	  // Run WebP detection immediately (sync)
	  function checkWebpSupport() {
	    var img = new Image();
	    img.onload = function() {
	      var result = (img.width > 0) && (img.height > 0);
	      if(result) {
	        document.documentElement.classList.add('webp');
	      }
	      // Mark detection as complete either way
	      document.documentElement.classList.remove('webp-detecting');
	      document.documentElement.classList.add('webp-complete');
	    };
	    img.onerror = function() {
	      // Mark detection as complete on error
	      document.documentElement.classList.remove('webp-detecting');
	      document.documentElement.classList.add('webp-complete');
	    };
	    img.src = 'data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoBAAEAAwA0JaQAA3AA/vuUAAA=';
	  }
	  checkWebpSupport();
	</script>
	
	<!-- WebP image loader script -->
	<script src="{{ "assets/js/image-loader.js" | relative_url }}" defer></script>
	
	<!-- Preload banner image to prevent flash -->
	<script>
	  document.addEventListener("DOMContentLoaded", function() {
	    // WebP detection
	    function supportsWebP(callback) {
	      var webP = new Image();
	      webP.onload = webP.onerror = function() {
	        callback(webP.height === 2);
	      };
	      webP.src = 'data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA';
	    }
	    
	    // Add class to HTML element
	    supportsWebP(function(hasWebP) {
	      document.documentElement.classList.add(hasWebP ? 'webp' : 'no-webp');
	      
	      // Handle banner image preloading
	      var banner = document.getElementById('banner');
	      if (banner) {
	        var bannerStyle = window.getComputedStyle(banner);
	        var bannerBgUrl = bannerStyle.backgroundImage;
	        
	        // Extract URL from background-image
	        var urlMatch = bannerBgUrl.match(/url\(['"]?([^'"]+)['"]?\)/);
	        if (urlMatch && urlMatch[1]) {
	          var imgUrl = urlMatch[1];
	          
	          // Check if we should use WebP version
	          if (hasWebP && (imgUrl.endsWith('.jpg') || imgUrl.endsWith('.jpeg') || imgUrl.endsWith('.png'))) {
	            imgUrl = imgUrl.substring(0, imgUrl.lastIndexOf('.')) + '.webp';
	          }
	          
	          // Create a new image object to preload
	          var img = new Image();
	          img.onload = function() {
	            // Set the background image once loaded
	            banner.style.backgroundImage = 'url(' + imgUrl + ')';
	            document.body.classList.add('banner-loaded');
	          };
	          img.src = imgUrl;
	        } else {
	          // If no background image or pattern not matched, show banner anyway
	          document.body.classList.add('banner-loaded');
	        }
	      } else {
	        document.body.classList.add('banner-loaded');
	      }
	      
	      // Handle regular image preloading
	      document.querySelectorAll('.image').forEach(function(el) {
	        el.classList.add('image-preload');
	        
	        // Find all images inside
	        var images = el.querySelectorAll('img');
	        var loadedCount = 0;
	        
	        if (images.length === 0) {
	          // No images to load
	          el.classList.add('image-loaded');
	        } else {
	          images.forEach(function(img) {
	            if (img.complete) {
	              loadedCount++;
	              if (loadedCount === images.length) {
	                el.classList.add('image-loaded');
	              }
	            } else {
	              img.addEventListener('load', function() {
	                loadedCount++;
	                if (loadedCount === images.length) {
	                  el.classList.add('image-loaded');
	                }
	              });
	            }
	          });
	        }
	      });
	    });
	  });
	</script>

	<script>
	  // Preload key images to prevent flash
	  document.addEventListener("DOMContentLoaded", function() {
	    // WebP detection
	    function supportsWebP(callback) {
	      var webP = new Image();
	      webP.onload = webP.onerror = function() {
	        callback(webP.height === 2);
	      };
	      webP.src = 'data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA';
	    }
	    
	    // Add class to HTML element
	    supportsWebP(function(hasWebP) {
	      document.documentElement.classList.add(hasWebP ? 'webp' : 'no-webp');
	      
	      // Preload all images
	      var imagesToLoad = document.querySelectorAll('.image img');
	      var totalImages = imagesToLoad.length;
	      var loadedImages = 0;
	      
	      function checkAllImagesLoaded() {
	        loadedImages++;
	        if (loadedImages >= totalImages) {
	          document.documentElement.classList.add('images-loaded');
	          setTimeout(function() {
	            document.documentElement.classList.add('page-loaded');
	          }, 100);
	        }
	      }
	      
	      if (totalImages === 0) {
	        // No images to preload
	        document.documentElement.classList.add('images-loaded');
	        setTimeout(function() {
	          document.documentElement.classList.add('page-loaded');
	        }, 100);
	      } else {
	        imagesToLoad.forEach(function(img) {
	          if (img.complete) {
	            checkAllImagesLoaded();
	          } else {
	            img.addEventListener('load', checkAllImagesLoaded);
	            img.addEventListener('error', checkAllImagesLoaded); // Count failed loads too
	          }
	        });
	        
	        // Fallback in case some images fail to trigger events
	        setTimeout(function() {
	          document.documentElement.classList.add('images-loaded');
	          document.documentElement.classList.add('page-loaded');
	        }, 1000); // 1 second timeout
	      }
	    });
	  });
	</script>
	
	<script>
	  // Ensure body becomes visible
	  document.addEventListener("DOMContentLoaded", function() {
	    // Add page-loaded class after a short delay to ensure images have started loading
	    setTimeout(function() {
	      document.documentElement.classList.add('page-loaded');
	      document.documentElement.classList.add('images-loaded');
	      console.log("Added page-loaded class");
	    }, 100);
	  });
	</script>
	
	<!-- Defer highlight.js scripts -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js" defer></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/julia.min.js" defer></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/r.min.js" defer></script>
	
	<!-- Initialize highlight.js after page load -->
	<script>
		window.addEventListener('DOMContentLoaded', function() {
			if (document.querySelector('pre code')) {
				var highlightInterval = setInterval(function() {
					if (typeof hljs !== 'undefined') {
						hljs.highlightAll();
						clearInterval(highlightInterval);
					}
				}, 100);
				
				setTimeout(function() {
					clearInterval(highlightInterval);
				}, 3000); // Safety timeout
			}
		});
	</script>
	
	<!--[if lte IE 9]><link rel="stylesheet" href="{{ "assets/css/ie9.css" | relative_url }}" /><![endif]-->
	<!--[if lte IE 8]><link rel="stylesheet" href="{{ "assets/css/ie8.css" | relative_url }}" /><![endif]-->
	<!--[if lte IE 8]><script src="{{ "assets/js/ie/html5shiv.js" | relative_url }}"></script><![endif]-->
	
	{% if jekyll.environment == 'production' and site.google_analytics %}
	{% include analytics.html %}
	{% endif %}
	
	<!-- Defer Google Tag Manager loading -->
	<script>
	window.addEventListener('load', function() {
		setTimeout(function() {
			var gtmScript = document.createElement('script');
			gtmScript.async = true;
			gtmScript.src = 'https://www.googletagmanager.com/gtag/js?id=G-7SN6EM0RMM';
			document.head.appendChild(gtmScript);
			
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
			gtag('config', 'G-7SN6EM0RMM', {
				'send_page_view': false
			});
			
			gtmScript.onload = function() {
				gtag('event', 'page_view', {
					page_title: document.title,
					page_location: window.location.href,
					page_path: window.location.pathname
				});
			};
		}, 1000);
	});
	</script>
</head>
