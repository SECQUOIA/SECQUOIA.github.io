name: CI - Test Jekyll Build

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Ruby for Jekyll
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true  # Enable caching to speed up builds

      # Clear any existing bundle config
      - name: Clear bundle config
        run: |
          rm -rf .bundle
          bundle config --local path vendor/bundle

      # Install dependencies
      - name: Install dependencies
        run: bundle install

      # Check for Jekyll configuration issues
      - name: Check Jekyll configuration
        run: bundle exec jekyll doctor

      # Build the site (test build)
      - name: Test Jekyll build
        run: bundle exec jekyll build --verbose
        env:
          JEKYLL_ENV: test

      # Validate site can be packaged for GitHub Pages (dry-run deployment test)
      - name: Validate Pages artifact structure
        run: |
          # Check _site exists and has content
          if [ ! -d "_site" ] || [ -z "$(ls -A _site)" ]; then
            echo "::error::Build failed - _site directory is empty or missing"
            exit 1
          fi
          # Check for index.html
          if [ ! -f "_site/index.html" ]; then
            echo "::error::Build failed - index.html not found in _site"
            exit 1
          fi
          echo "‚úÖ Site structure validated for GitHub Pages deployment"
          echo "## ‚úÖ Deployment Dry-Run Passed" >> $GITHUB_STEP_SUMMARY
          echo "Site structure is valid for GitHub Pages." >> $GITHUB_STEP_SUMMARY

      # Check for broken internal links using html-proofer
      - name: Test internal links
        id: linkcheck
        run: |
          # Site was already built in previous step, use html-proofer to check links
          set +e
          bundle exec htmlproofer ./_site --disable-external --checks Links,Images,Scripts > linkcheck.log 2>&1
          EXITCODE=$?
          cat linkcheck.log
          exit $EXITCODE
        continue-on-error: true

      - name: Report link check failures as warning
        if: steps.linkcheck.outcome == 'failure'
        run: |
          echo "::warning file=linkcheck.log::Broken internal links detected. See the 'Test internal links' step for details."
          echo "## ‚ö†Ô∏è Internal Link Check Failed" >> $GITHUB_STEP_SUMMARY
          echo "Some internal links are broken. Check the logs or download the artifact for details." >> $GITHUB_STEP_SUMMARY

      # Check external links (social media profiles, emails, etc.)
      - name: Test external links
        id: external_linkcheck
        run: |
          # Check external links with rate limiting to avoid being blocked
          # Allow some failures as external sites may be temporarily down
          set +e
          bundle exec htmlproofer ./_site \
            --checks Links \
            --ignore-urls "/localhost/,/127.0.0.1/" \
            --typhoeus "{\"timeout\": 30, \"connecttimeout\": 10}" \
            --hydra "{\"max_concurrency\": 10}" \
            --cache "{\"timeframe\": {\"external\": \"1d\"}}" \
            --ignore-status-codes "0,429,999" \
            > external_linkcheck.log 2>&1
          EXITCODE=$?
          cat external_linkcheck.log
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Report external link check failures as warning
        if: steps.external_linkcheck.outputs.exitcode != '0'
        run: |
          echo "::warning::Some external links may be broken or unreachable. See the 'Test external links' step for details. This may be due to rate limiting or temporary outages."
          echo "## ‚ö†Ô∏è External Link Check Failed" >> $GITHUB_STEP_SUMMARY
          echo "Some external links may be broken or unreachable. This may be due to rate limiting or temporary outages." >> $GITHUB_STEP_SUMMARY

      # Upload link check logs as artifacts for later review
      - name: Upload link check logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-check-logs
          path: |
            linkcheck.log
            external_linkcheck.log
          retention-days: 30
          if-no-files-found: ignore

      # Enforce usage-based WebP policy after build
      - name: Check referenced images are WebP
        run: |
          bash scripts/check_referenced_images.sh
        continue-on-error: false

      - name: Image usage summary
        if: success()
        run: |
          echo "## üñº Image Usage Audit Passed" >> $GITHUB_STEP_SUMMARY
          echo "All referenced site images are WebP." >> $GITHUB_STEP_SUMMARY

      - name: Image usage summary (failure)
        if: failure()
        run: |
          echo "## ‚ùå Image Usage Audit Failed" >> $GITHUB_STEP_SUMMARY
          echo "One or more referenced images are not WebP. Convert and update references." >> $GITHUB_STEP_SUMMARY

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Check for common file issues
      - name: Check file encoding and line endings
        run: |
          # Check for non-UTF8 files
          find . -name "*.md" -o -name "*.yml" -o -name "*.yaml" | grep -v vendor | xargs file | grep -v "UTF-8" || echo "All text files are UTF-8"

          # Check for trailing whitespace (warning only, doesn't fail)
          if grep -r --include="*.md" --include="*.yml" --include="*.yaml" --exclude-dir=vendor '[[:space:]]$' .; then
            echo "‚ö†Ô∏è Warning: Found trailing whitespace in files above (not blocking merge)"
          else
            echo "‚úÖ No trailing whitespace found"
          fi

      # Validate YAML files
      - name: Validate YAML files
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint
          find . -name "*.yml" -o -name "*.yaml" | grep -v vendor | xargs yamllint -d relaxed

      # Check Markdown files
      - name: Lint Markdown files
        uses: articulate/actions-markdownlint@v1
        with:
          config: .markdownlint.json
          files: '**/*.md'
          ignore: 'node_modules,vendor'
