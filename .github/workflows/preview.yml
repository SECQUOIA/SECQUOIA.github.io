name: Preview Build

on:
  pull_request:
    branches: [ main, master, '**' ]

permissions:
  contents: read
  actions: read

jobs:
  preview:
    # Environment provides a deploy-style status GitHub can require in branch protection.
    environment:
      name: preview
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Clear bundle config
        run: |
          rm -rf .bundle
          bundle config --local path vendor/bundle

      - name: Install dependencies
        run: bundle install

      - name: Build Jekyll site (preview)
        run: bundle exec jekyll build --verbose
        env:
          JEKYLL_ENV: preview

      # Internal link and asset check (non-blocking)
      - name: Check internal links & assets
        id: internal_links
        run: |
          set +e
          bundle exec htmlproofer ./_site --disable-external --checks Links,Images,Scripts > linkcheck_preview.log 2>&1
          EXITCODE=$?
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
          cat linkcheck_preview.log
        continue-on-error: true

      # External link check (rate-limited, non-blocking)
      - name: Check external links
        id: external_links
        run: |
          set +e
          bundle exec htmlproofer ./_site \
            --checks Links \
            --ignore-urls "/localhost/,/127.0.0.1/,/fonts.googleapis.com/,/fonts.gstatic.com/" \
            --typhoeus "{\"timeout\": 30, \"connecttimeout\": 10}" \
            --hydra "{\"max_concurrency\": 10}" \
            --cache "{\"timeframe\": {\"external\": \"1d\"}}" \
            --ignore-status-codes "0,429,999" \
            > external_linkcheck_preview.log 2>&1
          EXITCODE=$?
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
          cat external_linkcheck_preview.log
        continue-on-error: true

      - name: Upload link check logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preview-link-check-logs
          path: |
            linkcheck_preview.log
            external_linkcheck_preview.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload built site as artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-site
          path: _site
          retention-days: 7

      - name: Summarize preview
        run: |
          echo "## ðŸ” Preview Build Artifact" >> $GITHUB_STEP_SUMMARY
          echo "Download the 'preview-site' artifact from this workflow run to inspect the generated site." >> $GITHUB_STEP_SUMMARY
          echo "This is a non-production build; it does not publish to GitHub Pages." >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.internal_links.outputs.exitcode }}" != "0" ]; then
            echo "\n### âš ï¸ Internal Link Check Issues" >> $GITHUB_STEP_SUMMARY
            echo "Some internal links or assets may be broken. See artifact 'preview-link-check-logs'." >> $GITHUB_STEP_SUMMARY
          else
            echo "\nâœ… Internal link & asset check passed." >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.external_links.outputs.exitcode }}" != "0" ]; then
            echo "\n### âš ï¸ External Link Check Issues" >> $GITHUB_STEP_SUMMARY
            echo "Some external links may be unreachable (could be transient). See logs artifact." >> $GITHUB_STEP_SUMMARY
          else
            echo "\nâœ… External link check passed." >> $GITHUB_STEP_SUMMARY
          fi
